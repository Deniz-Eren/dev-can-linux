/**
 * \file    Jenkinsfile
 * \brief   Jenkinsfile Groovy script
 *
 * Copyright (C) 2022 Deniz Eren <deniz.eren@outlook.com>
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along
 * with this program; if not, write to the Free Software Foundation, Inc.,
 * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
 */

node('jenkins_agent') {

    def buildpath = "/var/tmp/$NODE_NAME";

    try {
        stage('checkout and setup containers') {
            sh(script: """
                rm -rf $buildpath
                mkdir -p $buildpath
            """)

            checkout([$class: 'GitSCM',
                branches: [[name: '*/main']],
                extensions: [[$class: 'RelativeTargetDirectory',
                    relativeTargetDir: "$buildpath/dev-can-linux/"]],
                userRemoteConfigs: [[
                    credentialsId: '',
                    url: '/opt/dev-can-linux'
                ]]])

            def publisher = LastChanges.getLastChangesPublisher \
                null, "SIDE", "LINE", true, true, \
                "", "", "", "$buildpath/dev-can-linux", ""

            publisher.publishLastChanges()

            sh(script: """
                cd /opt/dev-can-linux/dev

                docker build \
                    -f /opt/dev-can-linux/dev/qnx.Dockerfile \
                    -t localhost/dev-can-linux-dev .

                docker run -d --name=dev_env \
                    --network host \
                    localhost/dev-can-linux-dev tail -f /dev/null

                docker cp /opt/dev-can-linux dev_env:/root/

                cd /opt/dev-can-linux/tests/emulation

                docker build \
                    -f /opt/dev-can-linux/tests/emulation/qemu.Dockerfile \
                    -t localhost/dev-can-linux-qemu .

                docker run -d --name=qemu_env \
                    --network host \
                    --device=/dev/kvm \
                    localhost/dev-can-linux-qemu tail -f /dev/null

                docker exec --user root --workdir /root dev_env bash -c \
                    "source .profile \
                    && /root/dev-can-linux/dev/setup-profile.sh \
                    && cd /root/dev-can-linux/tests/image \
                    && ./builddisk.sh"

                rm -rf /home/jenkins/Images

                docker cp dev_env:/root/dev-can-linux/tests/image/output \
                    /home/jenkins/Images

                docker cp /home/jenkins/Images qemu_env:/root/Images
            """)
        }

        stage('integration testing (with coverage)') {
            sh(script: """
                /opt/dev-can-linux/ci/jenkins/scripts/integration-testing.sh
            """)

            publishHTML(target : [allowMissing: false,
                alwaysLinkToLastBuild: true,
                keepAll: true,
                reportDir: 'test-coverage-qcc',
                reportFiles: 'index.html',
                reportName: 'Coverage Report (QCC)',
                reportTitles: 'Coverage Report (QCC)'])
        }

        stage('release') {
            sh(script: """
                docker exec --user root --workdir /root dev_env \
                    bash -c "source .profile \
                        && /root/dev-can-linux/dev/setup-profile.sh \
                        && mkdir -p build_release \
                        && cd build_release \
                        && cmake -DCMAKE_BUILD_TYPE=Release \
                                ../dev-can-linux \
                        && make -j8 \
                        && cpack \
                        && DIR=\\\"Release/dev-can-linux/\\\$(date \\\"+%Y-%m-%d-%H%M%S%Z\\\")\\\" \
                        && mkdir -p \\\"\\\$DIR\\\" \
                        && cp dev-can-linux-*.tar.gz \\\"\\\$DIR\\\""

                docker cp \
                    dev_env:/root/build_release/Release/dev-can-linux \
                    /var/Release/
            """)
        }
    }
    catch (err) {
        currentBuild.result = 'FAILURE'
    }
    finally {
        stage('clean-up') {
            sh(script: """
                docker stop dev_env
                docker rm dev_env

                docker stop qemu_env
                docker rm qemu_env

                rm -rf $buildpath
            """)
        }
    }
}
